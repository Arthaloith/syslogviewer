<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>RPI Syslog Viewer</title>
    <style>
      :root{
        --bg:#f7f9fb; --card:#fff; --muted:#6b7280; --accent:#0066d6; --accent-2:#e6f2ff;
        --sidebar-bg:#f3f6f8; --border:#e2e8ee;
      }
      *{box-sizing:border-box}
      body { font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 0; display: flex; height: 100vh; background: var(--bg); color:#111; }
      #sidebar { width: 340px; background: var(--sidebar-bg); border-right: 1px solid var(--border); padding: 16px; overflow-y: auto; }
      #main { flex: 1; display: flex; flex-direction: column; }
      h3{margin:0 0 12px 0;font-weight:700;color:#0b1220}
      .create-row{display:flex;gap:8px;align-items:center;margin-bottom:14px}
      .pill{
        display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:var(--card);
        border:1px solid var(--border);box-shadow:0 1px 2px rgba(11,15,25,0.02);flex:1;
      }
      .pill input{border:0;outline:none;flex:1;font-size:14px;background:transparent}
      .icon-btn{width:40px;height:40px;border-radius:10px;display:inline-grid;place-items:center;border:0;background:linear-gradient(180deg,var(--accent),#0050b8);color:#fff;cursor:pointer}
      .icon-btn[aria-disabled="true"]{opacity:0.5;cursor:not-allowed}
      .hint{font-size:13px;color:var(--muted);margin-top:6px}
      .folder-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:8px;margin-bottom:10px;box-shadow:0 1px 2px rgba(16,24,40,0.03)}
      .folder-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
      .folder-title{font-weight:600;color:#0f1724}
      .folder-meta{font-size:12px;color:var(--muted)}
      .file-list{display:flex;flex-direction:column;gap:6px}
      .file-item{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;cursor:pointer}
      .file-item:hover{background:var(--accent-2)}
      .file-name{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; color:#0b1220}
      .file-actions{display:flex;gap:6px;align-items:center}
      .menu-btn{background:transparent;border:0;color:var(--muted);font-size:16px;cursor:pointer;padding:6px;border-radius:6px}
      #controls { padding: 10px 12px; border-bottom: 1px solid var(--border); display: flex; gap: 8px; align-items: center; background: linear-gradient(180deg,#fff, #fbfdff); }
      #log { flex: 1; background: #0b1220; color: #e6eef8; padding: 14px; font-family: monospace; overflow: auto; white-space: pre-wrap; }
      .muted{color:var(--muted);font-size:13px}
      .menu-panel{position:absolute;background:var(--card);border:1px solid var(--border);box-shadow:0 6px 18px rgba(11,15,25,0.08);border-radius:8px;padding:6px;min-width:160px;z-index:40}
      .menu-panel button{display:block;width:100%;text-align:left;background:transparent;border:0;padding:8px;border-radius:6px;color:#0b1220}
      .menu-panel button:hover{background:#f2f7ff}
      .feedback{font-size:13px;padding:6px 10px;border-radius:8px}
      .success{background:#eef9f1;color:#05632a;border:1px solid #d4f5de}
      .error{background:#fff5f5;color:#990f0f;border:1px solid #ffdede}
      .delete-btn{background: #dc2626;color: #fff;border: none;padding: 6px 12px;font-size: 13px;border-radius: 6px;cursor: pointer;box-shadow: 0 1px 2px rgba(11,15,25,0.06);transition: background 0.2s ease-in-out;}
      .delete-btn:hover{background: #b91c1c}
    </style>
  </head>
  <body>
    <div id="sidebar">
      <h3>Log files</h3>

      <div class="create-row">
        <div class="pill" role="group" aria-label="create folder">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="opacity:0.65">
            <path d="M3 7a2 2 0 0 1 2-2h4l2 2h8a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z" stroke="#111" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <input id="newFolderName" placeholder="New folder name" type="text" maxlength="64" />
          <button id="createIcon" class="icon-btn" title="Create folder" aria-disabled="true">+</button>
        </div>
      </div>
      <div id="createFeedback" style="height:34px;margin-bottom:8px"></div>
      <div class="hint">Folders are virtual and stored next to the app as <code>.folders.json</code>. Deleting a folder won't remove files.</div>

      <div id="folders" style="margin-top:12px"></div>

      <div style="margin-top:8px;margin-bottom:6px"><strong>Unsorted</strong> <span class="muted" id="unsorted-count"></span></div>
      <div id="files"></div>
    </div>

    <div id="main">
      <div id="controls">
        <div id="current" class="muted">Not connected</div>
        <div style="flex:1"></div>
        <button id="clear" class="ghost" title="Clear log view">Clear</button>
      </div>
      <div id="log"></div>
    </div>

    <script src="/static/socket.io.min.js"></script>
    <script>
      const socket = io();
      let currentFile = null;
      let foldersOrder = [];

      const logEl = document.getElementById("log");
      const currentEl = document.getElementById("current");

      socket.on("log_line", (data)=>{
        if (data.file !== currentFile) return;
        logEl.textContent += data.line;
        logEl.scrollTop = logEl.scrollHeight;
      });

      socket.on("log_error", (data)=>{
        if (data.file !== currentFile) return;
        logEl.textContent += "\\n[Error: " + data.error + "]\\n";
      });

      document.getElementById("clear").onclick = ()=>{
        logEl.textContent = "";
      };

      function setActive(file){
        if (currentFile){
          socket.emit("leave", {file: currentFile});
        }
        currentFile = file;
        currentEl.textContent = file;
        logEl.textContent = "";
        socket.emit("join", {file});
      }

      async function refresh(){
        const res = await fetch("/logs/list");
        const data = await res.json();
        const files = data.unsorted || [];
        const folders = data.folders || {};
        foldersOrder = Object.keys(folders);

        const filesEl = document.getElementById("files");
        filesEl.innerHTML = "";
        files.forEach(f=>{
          filesEl.appendChild(renderFileItem(f));
        });
        document.getElementById("unsorted-count").textContent = files.length;

        const foldersEl = document.getElementById("folders");
        foldersEl.innerHTML = "";
        foldersOrder.forEach(folder=>{
          const card = document.createElement("div");
          card.className = "folder-card";
          const head = document.createElement("div");
          head.className = "folder-header";
          const title = document.createElement("div");
          title.className = "folder-title";
          title.textContent = folder;
          head.appendChild(title);
          const meta = document.createElement("div");
          meta.className = "folder-meta";
          meta.textContent = (folders[folder]||[]).length + " files";
          head.appendChild(meta);
          card.appendChild(head);
          const list = document.createElement("div");
          list.className = "file-list";
          (folders[folder]||[]).forEach(f=>{
            list.appendChild(renderFileItem(f));
          });
          card.appendChild(list);
          foldersEl.appendChild(card);
        });
      }

      function renderFileItem(f){
        const row = document.createElement("div");
        row.className = "file-item";
        row.dataset.file = f;

        const left = document.createElement("div");
        left.style.display = "flex";
        left.style.alignItems = "center";
        left.style.gap = "10px";
        const name = document.createElement("div");
        name.className = "file-name";
        name.textContent = f;
        left.appendChild(name);

        const actions = document.createElement("div");
        actions.className = "file-actions";

        // ⬇️ Download button
        const dlBtn = document.createElement("a");
        dlBtn.href = `/logs/download/${encodeURIComponent(f)}`;
        dlBtn.textContent = "⬇️";
        dlBtn.title = "Download log file";
        dlBtn.style.textDecoration = "none";
        dlBtn.style.fontSize = "16px";
        dlBtn.style.padding = "6px";
        dlBtn.style.borderRadius = "6px";
        dlBtn.style.color = "#111";
        actions.appendChild(dlBtn);

        // ⋯ Move menu button
        const menuBtn = document.createElement("button");
        menuBtn.className = "menu-btn";
        menuBtn.innerHTML = "⋯";
        menuBtn.title = "Move file to folder";
        menuBtn.onclick = (ev)=>{ ev.stopPropagation(); openMoveMenu(menuBtn, f, foldersOrder); };
        actions.appendChild(menuBtn);

        row.appendChild(left);
        row.appendChild(actions);
        row.onclick = ()=> setActive(f);
        return row;
      }

      function openMoveMenu(anchor, file, folders){
        const old = document.querySelector(".menu-panel");
        if (old) old.remove();
        const panel = document.createElement("div");
        panel.className = "menu-panel";
        folders.forEach(f=>{
          const btn = document.createElement("button");
          btn.textContent = "Move to " + f;
          btn.onclick = async()=>{
            await fetch("/folders/move",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({file,target:f})});
            panel.remove();
            refresh();
          };
          panel.appendChild(btn);
        });
        const btn = document.createElement("button");
        btn.textContent = "Remove from folder";
        btn.onclick = async()=>{
          await fetch("/folders/move",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({file,target:""})});
          panel.remove();
          refresh();
        };
        panel.appendChild(btn);
        document.body.appendChild(panel);
        const rect = anchor.getBoundingClientRect();
        panel.style.top = rect.bottom+"px";
        panel.style.left = rect.left+"px";
      }

      document.body.addEventListener("click", ()=>{ 
        const old = document.querySelector(".menu-panel"); 
        if (old) old.remove(); 
      });

      refresh();
    </script>
  </body>
</html>
