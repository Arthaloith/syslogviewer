<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>RPI Syslog Viewer</title>
    <style>
      :root{
        --bg:#f7f9fb; --card:#fff; --muted:#6b7280; --accent:#0066d6; --accent-2:#e6f2ff;
        --sidebar-bg:#f3f6f8; --border:#e2e8ee;
      }
      *{box-sizing:border-box}
      body { font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 0; display: flex; height: 100vh; background: var(--bg); color:#111; }
      #sidebar { width: 340px; background: var(--sidebar-bg); border-right: 1px solid var(--border); padding: 16px; overflow-y: auto; }
      #main { flex: 1; display: flex; flex-direction: column; }
      h3{margin:0 0 12px 0;font-weight:700;color:#0b1220}
      .create-row{display:flex;gap:8px;align-items:center;margin-bottom:14px}
      .pill{
        display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:var(--card);
        border:1px solid var(--border);box-shadow:0 1px 2px rgba(11,15,25,0.02);flex:1;
      }
      .pill input{border:0;outline:none;flex:1;font-size:14px;background:transparent}
      .icon-btn{width:40px;height:40px;border-radius:10px;display:inline-grid;place-items:center;border:0;background:linear-gradient(180deg,var(--accent),#0050b8);color:#fff;cursor:pointer}
      .icon-btn[aria-disabled="true"]{opacity:0.5;cursor:not-allowed}
      .hint{font-size:13px;color:var(--muted);margin-top:6px}
      .folder-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:8px;margin-bottom:10px;box-shadow:0 1px 2px rgba(16,24,40,0.03)}
      .folder-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
      .folder-title{font-weight:600;color:#0f1724}
      .folder-meta{font-size:12px;color:var(--muted)}
      .file-list{display:flex;flex-direction:column;gap:6px}
      .file-item{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;cursor:pointer}
      .file-item:hover{background:var(--accent-2)}
      .file-name{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; color:#0b1220}
      .file-actions{display:flex;gap:6px;align-items:center}
      .menu-btn{background:transparent;border:0;color:var(--muted);font-size:16px;cursor:pointer;padding:6px;border-radius:6px}
      #controls { padding: 10px 12px; border-bottom: 1px solid var(--border); display: flex; gap: 8px; align-items: center; background: linear-gradient(180deg,#fff, #fbfdff); }
      #log { flex: 1; background: #0b1220; color: #e6eef8; padding: 14px; font-family: monospace; overflow: auto; white-space: pre-wrap; }
      .muted{color:var(--muted);font-size:13px}
      .menu-panel{position:absolute;background:var(--card);border:1px solid var(--border);box-shadow:0 6px 18px rgba(11,15,25,0.08);border-radius:8px;padding:6px;min-width:160px;z-index:40}
      .menu-panel button{display:block;width:100%;text-align:left;background:transparent;border:0;padding:8px;border-radius:6px;color:#0b1220}
      .menu-panel button:hover{background:#f2f7ff}
      .feedback{font-size:13px;padding:6px 10px;border-radius:8px}
      .success{background:#eef9f1;color:#05632a;border:1px solid #d4f5de}
      .error{background:#fff5f5;color:#990f0f;border:1px solid #ffdede\}
      .delete-btn{background: #dc2626;color: #fff;border: none;padding: 6px 12px;font-size: 13px;border-radius: 6px;cursor: pointer;box-shadow: 0 1px 2px rgba(11,15,25,0.06);transition: background 0.2s ease-in-out;}
      .delete-btn:hover{background: #b91c1c}
    </style>
  </head>
  <body>
    <div id="sidebar">
      <h3>Log files</h3>

      <div class="create-row">
        <div class="pill" role="group" aria-label="create folder">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="opacity:0.65">
            <path d="M3 7a2 2 0 0 1 2-2h4l2 2h8a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z" stroke="#111" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <input id="newFolderName" placeholder="New folder name" type="text" maxlength="64" />
          <button id="createIcon" class="icon-btn" title="Create folder" aria-disabled="true">+</button>
        </div>
      </div>
      <div id="createFeedback" style="height:34px;margin-bottom:8px"></div>
      <div class="hint">Folders are virtual and stored next to the app as <code>.folders.json</code>. Deleting a folder won't remove files.</div>

      <div id="folders" style="margin-top:12px"></div>

      <div style="margin-top:8px;margin-bottom:6px"><strong>Unsorted</strong> <span class="muted" id="unsorted-count"></span></div>
      <div id="files"></div>
    </div>

    <div id="main">
      <div id="controls">
        <div id="current" class="muted">Not connected</div>
        <div style="flex:1"></div>
        <button id="clear" class="ghost" title="Clear log view">Clear</button>
      </div>
      <div id="log"></div>
    </div>

    <script src="/static/socket.io.min.js"></script>
    <script>
      const foldersEl = document.getElementById("folders");
      const filesEl = document.getElementById("files");
      const logEl = document.getElementById("log");
      const currentEl = document.getElementById("current");
      const input = document.getElementById("newFolderName");
      const createIcon = document.getElementById("createIcon");
      const feedback = document.getElementById("createFeedback");
      let currentFile = null;
      let menuState = {openEl: null, panel: null};
      let foldersOrder = [];

      const socket = io();

      socket.on("connect", () => console.log("socket connected"));
      socket.on("log_line", (data) => { if (data.file === currentFile) appendLine(data.line); });
      socket.on("log_error", (data) => { if (data.file === currentFile) appendLine("[ERROR] " + data.error + "\n"); });

      function appendLine(text){
        const atBottom = (Math.abs((logEl.scrollHeight - logEl.clientHeight) - logEl.scrollTop) < 24);
        logEl.textContent += text;
        if (atBottom) logEl.scrollTop = logEl.scrollHeight;
      }

      function setActive(file){
        if (currentFile === file) return;
        if (currentFile) socket.emit("leave", {file: currentFile});
        currentFile = file;
        currentEl.textContent = file;
        logEl.textContent = "";
        socket.emit("join", {file});
        document.querySelectorAll(".file-item").forEach(el => el.classList.toggle("active", el.dataset.file === file));
      }

      function showFeedback(message, type){
        feedback.innerHTML = "";
        if(!message) return;
        const d = document.createElement("div");
        d.className = "feedback " + (type === "ok" ? "success" : "error");
        d.textContent = message;
        feedback.appendChild(d);
        setTimeout(()=> { if (feedback.contains(d)) feedback.removeChild(d); }, 4000);
      }

      function closeMenu(){
        if(menuState.panel){
          menuState.panel.remove();
          menuState.openEl = null;
          menuState.panel = null;
        }
      }

      function openMoveMenu(buttonEl, fileName, folders){
        closeMenu();
        const rect = buttonEl.getBoundingClientRect();
        const panel = document.createElement("div");
        panel.className = "menu-panel";
        panel.style.top = (rect.bottom + window.scrollY + 6) + "px";
        panel.style.left = (rect.left + window.scrollX) + "px";

        const uns = document.createElement("button");
        uns.textContent = "Move to Unsorted";
        uns.onclick = (ev)=> { ev.stopPropagation(); doMove(fileName, ""); closeMenu(); };
        panel.appendChild(uns);

        panel.appendChild(document.createElement("hr"));

        folders.forEach(fn=>{
          const b = document.createElement("button");
          b.textContent = "Move to " + fn;
          b.onclick = (ev)=>{ ev.stopPropagation(); doMove(fileName, fn); closeMenu(); };
          panel.appendChild(b);
        });

        document.body.appendChild(panel);
        menuState.openEl = buttonEl;
        menuState.panel = panel;

        setTimeout(()=> {
          const onDoc = (ev)=>{
            if (!panel.contains(ev.target) && ev.target !== buttonEl) {
              closeMenu();
              document.removeEventListener("click", onDoc);
            }
          };
          document.addEventListener("click", onDoc);
        }, 0);
      }

      function doMove(file, target){
        fetch("/folders/move", {
          method:"POST", headers:{"Content-Type":"application/json"},
          body: JSON.stringify({file, target})
        }).then(()=> loadFiles());
      }

      function renderFileItem(f){
        const row = document.createElement("div");
        row.className = "file-item";
        row.dataset.file = f;

        const left = document.createElement("div");
        left.style.display = "flex";
        left.style.alignItems = "center";
        left.style.gap = "10px";
        const name = document.createElement("div");
        name.className = "file-name";
        name.textContent = f;
        left.appendChild(name);

        const actions = document.createElement("div");
        actions.className = "file-actions";
        const menuBtn = document.createElement("button");
        menuBtn.className = "menu-btn";
        menuBtn.innerHTML = "â‹¯";
        menuBtn.title = "Move file to folder";
        menuBtn.onclick = (ev)=>{ ev.stopPropagation(); openMoveMenu(menuBtn, f, foldersOrder); };

        actions.appendChild(menuBtn);

        row.appendChild(left);
        row.appendChild(actions);
        row.onclick = ()=> setActive(f);
        return row;
      }

      function renderFolderCard(name, files){
        const card = document.createElement("div");
        card.className = "folder-card";

        const header = document.createElement("div");
        header.className = "folder-header";
        const title = document.createElement("div");
        title.className = "folder-title";
        title.textContent = name;
        const meta = document.createElement("div");
        meta.style.display = "flex";
        meta.style.alignItems = "center";
        meta.style.gap = "8px";
        const count = document.createElement("div");
        count.className = "folder-meta";
        count.textContent = files.length + " file" + (files.length!==1 ? "s":"");
        const del = document.createElement("button");
        del.className = "delete-btn";
        del.textContent = "ðŸ—‘ Delete";
        del.onclick = (ev)=>{ ev.stopPropagation(); if(!confirm("Delete folder '"+name+"'?")) return; fetch("/folders/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name})}).then(()=> loadFiles()); };

        meta.appendChild(count);
        meta.appendChild(del);

        header.appendChild(title);
        header.appendChild(meta);
        card.appendChild(header);

        const list = document.createElement("div");
        list.className = "file-list";
        files.forEach(f=> list.appendChild(renderFileItem(f)));
        card.appendChild(list);
        return card;
      }

      function loadFiles(){
        fetch("/logs/list").then(r=>r.json()).then(data=>{
          const folders = data.folders || {};
          const unsorted = data.unsorted || [];
          foldersOrder = Object.keys(folders);
          foldersEl.innerHTML = "";
          foldersOrder.forEach(fn=>{
            foldersEl.appendChild(renderFolderCard(fn, folders[fn]||[]));
          });
          filesEl.innerHTML = "";
          document.getElementById("unsorted-count").textContent = "(" + unsorted.length + ")";
          unsorted.forEach(f => filesEl.appendChild(renderFileItem(f)));
          closeMenu();
        });
      }

      // create folder UI behavior
      input.addEventListener("input", ()=>{
        const ok = input.value.trim().length > 0;
        createIcon.setAttribute("aria-disabled", ok ? "false" : "true");
        createIcon.style.opacity = ok ? "1" : "0.5";
      });

      function createFolder(){
        const name = input.value.trim();
        if(!name) return;
        createIcon.setAttribute("aria-disabled", "true");
        fetch("/folders/create", {
          method:"POST", headers:{"Content-Type":"application/json"},
          body: JSON.stringify({name})
        }).then(async r=>{
          if(r.ok){
            showFeedback("Folder '"+name+"' created", "ok");
            input.value = "";
            loadFiles();
          } else {
            const j = await r.json().catch(()=>({error:"unknown"}));
            showFeedback(j.error || "Could not create folder", "err");
          }
        }).finally(()=> {
          createIcon.setAttribute("aria-disabled", "false");
          createIcon.style.opacity = "1";
        });
      }

      createIcon.onclick = (ev)=>{
        if(createIcon.getAttribute("aria-disabled")==="true") return;
        createFolder();
      };

      input.addEventListener("keydown", (ev)=>{
        if(ev.key === "Enter"){
          ev.preventDefault();
          createFolder();
        }
      });

      document.getElementById("clear").onclick = () => { logEl.textContent = ""; };

      (function ensureSocketIO(){
        if (typeof io === "undefined") {
          const s = document.createElement("script");
          s.src = "https://cdn.jsdelivr.net/npm/socket.io-client@4/dist/socket.io.min.js";
          s.onload = () => { console.log("loaded socket.io client"); };
          document.head.appendChild(s);
        }
      })();

      loadFiles();
      setInterval(loadFiles, 15000);
    </script>
  </body>
</html>
