<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>RPI Syslog Viewer</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 0; display: flex; height: 100vh; }
      #sidebar { width: 260px; border-right: 1px solid #ddd; padding: 10px; box-sizing: border-box; overflow-y: auto; }
      #main { flex: 1; display: flex; flex-direction: column; }
      .tab { padding: 8px; cursor: pointer; border-radius: 4px; margin-bottom: 4px; background: #f5f5f5; }
      .tab.active { background: #e0f0ff; font-weight: bold; }
      #log { flex: 1; background: #111; color: #eee; padding: 10px; font-family: monospace; overflow: auto; white-space: pre-wrap; }
      #controls { padding: 8px; border-bottom: 1px solid #ddd; display: flex; gap: 8px; align-items: center; }
      button { padding: 6px 10px; }
    </style>
  </head>
  <body>
    <div id="sidebar">
      <h3>Log files</h3>
      <div id="files"></div>
    </div>
    <div id="main">
      <div id="controls">
        <div id="current">Not connected</div>
        <button id="clear">Clear</button>
      </div>
      <div id="log"></div>
    </div>

    <script src="/static/socket.io.min.js"></script>
    <script>
      const filesEl = document.getElementById("files");
      const logEl = document.getElementById("log");
      const currentEl = document.getElementById("current");
      let currentFile = null;
      // connect to socket.io (same host)
      const socket = io();

      socket.on("connect", () => {
        console.log("socket connected");
      });

      socket.on("log_line", (data) => {
        if (data.file !== currentFile) return;
        appendLine(data.line);
      });

      socket.on("log_error", (data) => {
        if (data.file !== currentFile) return;
        appendLine("[ERROR] " + data.error + "\n");
      });

      function appendLine(text) {
        const atBottom = (Math.abs((logEl.scrollHeight - logEl.clientHeight) - logEl.scrollTop) < 20);
        logEl.textContent += text;
        if (atBottom) {
          logEl.scrollTop = logEl.scrollHeight;
        }
      }

      function setActive(file) {
        if (currentFile === file) return;
        if (currentFile) {
          socket.emit("leave", {file: currentFile});
        }
        currentFile = file;
        currentEl.textContent = file;
        logEl.textContent = "";
        socket.emit("join", {file: file});
        // highlight
        document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", t.dataset.file === file));
      }

      function loadFiles() {
        fetch("/logs/list").then(r => r.json()).then(list => {
          filesEl.innerHTML = "";
          list.forEach(f => {
            const d = document.createElement("div");
            d.className = "tab";
            d.textContent = f;
            d.dataset.file = f;
            d.onclick = () => setActive(f);
            filesEl.appendChild(d);
          });
        });
      }

      document.getElementById("clear").onclick = () => { logEl.textContent = ""; };

      // load socket.io client lib fallback
      (function ensureSocketIO(){
        // If socket.io not loaded, load from CDN
        if (typeof io === "undefined") {
          const s = document.createElement("script");
          s.src = "https://cdn.jsdelivr.net/npm/socket.io-client@4/dist/socket.io.min.js";
          s.onload = () => { console.log("loaded socket.io client"); };
          document.head.appendChild(s);
        }
      })();

      loadFiles();
      // refresh file list occasionally
      setInterval(loadFiles, 15000);
    </script>
  </body>
</html>
